#!/usr/bin/env bash
set -euo pipefail

RED="$(tput setaf 1 2>/dev/null || true)"
GREEN="$(tput setaf 2 2>/dev/null || true)"
YELLOW="$(tput setaf 3 2>/dev/null || true)"
BLUE="$(tput setaf 4 2>/dev/null || true)"
RESET="$(tput sgr0 2>/dev/null || true)"

log() { echo "${BLUE}[ordersys-installer]${RESET} $*"; }
ok() { echo "${GREEN}[ordersys-installer]${RESET} $*"; }
warn() { echo "${YELLOW}[ordersys-installer]${RESET} $*"; }
err() { echo "${RED}[ordersys-installer]${RESET} $*" >&2; }

require_root() {
  if [[ "$EUID" -ne 0 ]]; then
    err "Installer must run as root."
    exit 1
  fi
}

require_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    err "Missing required command: $1"
    exit 1
  fi
}

ensure_base_packages() {
  export DEBIAN_FRONTEND=noninteractive
  apt-get update -y
  apt-get install -y curl ca-certificates gnupg lsb-release jq whiptail
}

install_docker_if_missing() {
  if command -v docker >/dev/null 2>&1; then
    ok "Docker already installed."
    return
  fi

  log "Installing Docker Engine + Compose plugin..."
  install -m 0755 -d /etc/apt/keyrings
  curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  chmod a+r /etc/apt/keyrings/docker.gpg

  local arch codename
  arch="$(dpkg --print-architecture)"
  codename="$(. /etc/os-release && echo "$VERSION_CODENAME")"
  echo "deb [arch=${arch} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian ${codename} stable" > /etc/apt/sources.list.d/docker.list

  apt-get update -y
  apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  systemctl enable --now docker
}

write_apt_manifest() {
  local install_path="$1"
  local manifest_dir="${install_path}/install"
  local manifest_file="${manifest_dir}/apt-manifest.txt"
  local generated_at
  local packages=(
    curl
    ca-certificates
    gnupg
    lsb-release
    jq
    whiptail
    docker-ce
    docker-ce-cli
    containerd.io
    docker-buildx-plugin
    docker-compose-plugin
  )

  install -d -m 0755 "$manifest_dir"
  generated_at="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
  {
    printf '# OrderSys apt manifest\n'
    printf 'generated_at=%s\n' "$generated_at"
    for pkg in "${packages[@]}"; do
      if dpkg-query -W -f='${Status}\t${Version}\n' "$pkg" 2>/dev/null | grep -q '^install ok installed'; then
        printf '%s=%s\n' "$pkg" "$(dpkg-query -W -f='${Version}' "$pkg")"
      else
        printf '%s=missing\n' "$pkg"
      fi
    done
  } > "$manifest_file"
  chmod 644 "$manifest_file"
}

random_secret() {
  local output=""
  while [[ ${#output} -lt 48 ]]; do
    output+=$(head -c 256 /dev/urandom | tr -dc 'A-Za-z0-9')
  done
  printf '%s' "${output:0:48}"
}

prompt_input() {
  local title="$1"
  local prompt="$2"
  local default_value="$3"
  whiptail --title "$title" --inputbox "$prompt" 10 78 "$default_value" 3>&1 1>&2 2>&3
}

upsert_env_key() {
  local env_file="$1"
  local key="$2"
  local value="$3"
  local tmp
  tmp="$(mktemp)"

  if [[ -f "$env_file" ]]; then
    awk -v k="$key" -v v="$value" '
      BEGIN { done=0 }
      $0 ~ "^"k"=" { print k"="v; done=1; next }
      { print }
      END { if (!done) print k"="v }
    ' "$env_file" > "$tmp"
  else
    printf '%s=%s\n' "$key" "$value" > "$tmp"
  fi

  mv "$tmp" "$env_file"
  chmod 600 "$env_file"
}

read_env_key() {
  local env_file="$1"
  local key="$2"
  if [[ ! -f "$env_file" ]]; then
    return 0
  fi
  sed -n "s/^${key}=//p" "$env_file" | head -n1
}

write_runtime_files() {
  local install_path="$1"
  local runtime_prod_dir="${install_path}/runtime/prod"
  local compose_file="${runtime_prod_dir}/docker-compose.yml"
  local nginx_file="${runtime_prod_dir}/nginx.ordersys.conf"

  install -d -m 0755 "$runtime_prod_dir"

  cat > "$compose_file" <<'YAML'
services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ordersys
      POSTGRES_USER: ordersys
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ordersys -d ordersys"]
      interval: 10s
      timeout: 5s
      retries: 12

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10

  backend:
    image: ${ORDERSYS_BACKEND_IMAGE}
    restart: unless-stopped
    environment:
      APP_VERSION: ${APP_VERSION:-}
      APP_RUNTIME_MODE: ${APP_RUNTIME_MODE:-PROD}
      AUTH_REFRESH_COOKIE_ALLOW_INSECURE: ${AUTH_REFRESH_COOKIE_ALLOW_INSECURE:-true}
      AUTH_REFRESH_COOKIE_SAMESITE: ${AUTH_REFRESH_COOKIE_SAMESITE:-lax}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      CORS_ALLOW_ORIGINS: ${CORS_ALLOW_ORIGINS}
      LOGIN_RL_BACKEND: ${LOGIN_RL_BACKEND:-redis}
      LOGIN_RL_REDIS_URL: ${LOGIN_RL_REDIS_URL:-redis://redis:6379/0}
      LOGIN_RL_MAX_KEYS: ${LOGIN_RL_MAX_KEYS:-50000}
      TRUSTED_PROXY_CIDRS: ${TRUSTED_PROXY_CIDRS:-127.0.0.1/32,::1/128,172.16.0.0/12}
      TRUSTED_PROXY_HOPS: ${TRUSTED_PROXY_HOPS:-1}
      UPDATE_CHECK_URL: ${UPDATE_CHECK_URL:-https://ordersys.stonewallmedia.co.uk/update/stable.json}
      ALLOW_UPDATE_SOURCE_OVERRIDE: ${ALLOW_UPDATE_SOURCE_OVERRIDE:-false}
      LICENSE_PUBLIC_KEY_PEM: ${LICENSE_PUBLIC_KEY_PEM:-}
      LICENSE_PUBLIC_KEY_PEM_FILE: ${LICENSE_PUBLIC_KEY_PEM_FILE:-/opt/ordersys/keys/license_public.pem}
      ORDERSYS_INSTANCE_ID_FILE: ${ORDERSYS_INSTANCE_ID_FILE:-/var/lib/ordersys/instance_id}
      DB_HOST: db
      DB_PORT: "5432"
      DB_NAME: ordersys
      DB_USER: ordersys
      DB_PASSWORD: ${DB_PASSWORD}
      DATABASE_URL: postgresql+psycopg://ordersys:${DB_PASSWORD}@db:5432/ordersys
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ordersys_state:/var/lib/ordersys

  frontend:
    image: ${ORDERSYS_FRONTEND_IMAGE}
    restart: unless-stopped
    environment:
      API_BASE: /api
      APP_VERSION: ${APP_VERSION:-}
    depends_on:
      - backend

  proxy:
    image: ${ORDERSYS_PROXY_IMAGE}
    restart: unless-stopped
    ports:
      - "${ORDERSYS_HTTP_PORT:-8080}:80"
    volumes:
      - ./nginx.ordersys.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - frontend
      - backend

volumes:
  postgres_data:
  ordersys_state:
YAML

  cat > "$nginx_file" <<'NGINX'
server {
    listen 80;
    server_name _;

    location = /index.html {
        return 404;
    }

    location = /legacy {
        return 404;
    }

    location ^~ /legacy/ {
        return 404;
    }

    location = /frontend-legacy {
        return 404;
    }

    location ^~ /frontend-legacy/ {
        return 404;
    }

    location / {
        proxy_pass http://frontend:80;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/ {
        proxy_pass http://backend:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location = /health {
        proxy_pass http://backend:8000/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location = /ready {
        proxy_pass http://backend:8000/ready;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
NGINX

  ln -sfn "./runtime/prod/docker-compose.yml" "${install_path}/docker-compose.yml"
  ln -sfn "./runtime/prod/nginx.ordersys.conf" "${install_path}/nginx.ordersys.conf"
}

write_license_public_key_file() {
  local key_file="$1"
  local key_b64="${ORDERSYS_LICENSE_PUBLIC_KEY_PEM_B64:-LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUFuMWpzaDA4SGQ4cDBucFlHL01vWQpTUjZpODRMb3I1OFE5VEVMaGZpb0U2WFBUZVp2cXVBQ05aMjMvQjUrUUN6WUgxVnRCM1ZkQVN6ZmNuVEMzZXdqCjJjanpYTHk2NXdzUS8yMVl4bmpiVGFzNVY5QkdPa0pQakl2d1hhb3ZOVllaanUyNzdGUFk2Q0xmcEVZWjdUa3QKYkR5NVJNVEFkT2F3VTlMQXU4Y3l1aEVYTHZDc0FnaTE0bkVTek1nUTZaZGkxU1N4Q2lUZmlydXhFanN0b2NIdApXTWlXZ0V5ZUlVK1N1SWZlZ2RvVU10ejBsTEp2UEdRQWV0VXJoMklRT3g5U0tSZ0tOS2hjMHkyM2JUd1VuVStnClFLTzl4VFlSWXlyWm4vZzFYSStPQVJzSzBBaE1jVmZqaVA4NzdZN0VnNVVzeGN6bzdGVHVlZCt4VXlraVRRREEKQlFJREFRQUIKLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tCg==}"
  install -d -m 0755 "$(dirname "$key_file")"

  if [[ -n "$key_b64" && "$key_b64" != "LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUFuMWpzaDA4SGQ4cDBucFlHL01vWQpTUjZpODRMb3I1OFE5VEVMaGZpb0U2WFBUZVp2cXVBQ05aMjMvQjUrUUN6WUgxVnRCM1ZkQVN6ZmNuVEMzZXdqCjJjanpYTHk2NXdzUS8yMVl4bmpiVGFzNVY5QkdPa0pQakl2d1hhb3ZOVllaanUyNzdGUFk2Q0xmcEVZWjdUa3QKYkR5NVJNVEFkT2F3VTlMQXU4Y3l1aEVYTHZDc0FnaTE0bkVTek1nUTZaZGkxU1N4Q2lUZmlydXhFanN0b2NIdApXTWlXZ0V5ZUlVK1N1SWZlZ2RvVU10ejBsTEp2UEdRQWV0VXJoMklRT3g5U0tSZ0tOS2hjMHkyM2JUd1VuVStnClFLTzl4VFlSWXlyWm4vZzFYSStPQVJzSzBBaE1jVmZqaVA4NzdZN0VnNVVzeGN6bzdGVHVlZCt4VXlraVRRREEKQlFJREFRQUIKLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tCg==" ]]; then
    printf '%s' "$key_b64" | base64 -d > "$key_file"
  elif [[ ! -f "$key_file" ]]; then
    cat > "$key_file" <<'KEY'
-----BEGIN PUBLIC KEY-----
REPLACE_WITH_VENDOR_PUBLIC_KEY
-----END PUBLIC KEY-----
KEY
  fi

  chmod 600 "$key_file"
}

run_deploy_flow() {
  local compose_file="$1"
  local env_file="$2"
  local migration_log

  log "Pulling images..."
  docker compose -p ordersys --env-file "$env_file" -f "$compose_file" pull

  log "Starting stack..."
  docker compose -p ordersys --env-file "$env_file" -f "$compose_file" up -d

  log "Applying migrations..."
  migration_log="$(mktemp)"
  if ! docker compose -p ordersys --env-file "$env_file" -f "$compose_file" run --rm backend alembic upgrade head >"$migration_log" 2>&1; then
    err "Database migration failed. Recent migration output:"
    tail -n 80 "$migration_log" >&2
    rm -f "$migration_log"
    exit 1
  fi
  rm -f "$migration_log"
  ok "Database migrations complete."

  docker compose -p ordersys --env-file "$env_file" -f "$compose_file" up -d
}

verify_health() {
  local port="$1"
  local base_url="http://127.0.0.1:${port}"
  for _ in $(seq 1 30); do
    if curl -fsS "${base_url}/health" >/dev/null 2>&1 && curl -fsS "${base_url}/ready" >/dev/null 2>&1; then
      ok "Health verification passed."
      return
    fi
    sleep 2
  done
  err "Health verification failed."
  exit 1
}

show_next_steps() {
  local access_url="$1"
  local dns_hint="$2"
  local compose_file="$3"
  local env_file="$4"
  cat <<NEXT

Next steps:
- Access URL: ${access_url}
- DNS guidance: ${dns_hint}
- Cookie mode: LAN HTTP enabled (AUTH_REFRESH_COOKIE_ALLOW_INSECURE=true). Set to false after enforcing HTTPS.
- Compose: ${compose_file}
- Env: ${env_file}
- Update command: ordersys update
- Logs: docker compose -p ordersys --env-file ${env_file} -f ${compose_file} logs -f

NEXT
}

show_completion_dialog() {
  local access_url="$1"
  if command -v whiptail >/dev/null 2>&1 && [[ -t 1 ]]; then
    whiptail --title "OrderSys Installer" --msgbox "OrderSys installation finished.\n\nOpen: ${access_url}\n\nRun setup wizard to create admin and start trial or apply a vendor key." 14 78 || true
  fi
}

require_root

if [[ ! -f /etc/debian_version ]]; then
  err "This installer currently targets Debian hosts."
  exit 1
fi

debian_major=""
if [[ -r /etc/os-release ]]; then
  debian_id="$(awk -F= '/^ID=/{gsub(/"/, "", $2); print $2}' /etc/os-release | head -n1)"
  if [[ "$debian_id" != "debian" ]]; then
    err "Unsupported distro ID: ${debian_id:-unknown}. This installer targets Debian 12/13."
    exit 1
  fi
  debian_version_id="$(awk -F= '/^VERSION_ID=/{gsub(/"/, "", $2); print $2}' /etc/os-release | head -n1)"
  debian_major="${debian_version_id%%.*}"
fi
if [[ -z "$debian_major" ]]; then
  debian_major="$(sed -n '1s/^\([0-9][0-9]*\).*/\1/p' /etc/debian_version | head -n1)"
fi
if [[ "$debian_major" != "12" && "$debian_major" != "13" ]]; then
  warn "Debian 12 and Debian 13 are validated targets. Detected Debian ${debian_major:-unknown}. Continuing anyway."
fi

whiptail --title "OrderSys Installer" --msgbox "This installer deploys OrderSys in production mode.\n\nDevelopment image/version overrides are disabled in this installer." 11 78

ensure_base_packages
install_docker_if_missing
require_cmd docker
require_cmd jq

install_path="/opt/ordersys"
env_file="/etc/ordersys/ordersys.env"
mode="fresh"

if [[ -d "$install_path" ]]; then
  choice="$(whiptail --title "OrderSys Installer" --menu "Existing install path detected (${install_path}). Choose action:" 14 88 3 \
    repair "Repair/redeploy (preserve data)" \
    update "Update only (no reconfigure)" \
    exit "Exit" 3>&1 1>&2 2>&3)"
  case "$choice" in
    repair) mode="repair" ;;
    update) mode="update" ;;
    *) exit 0 ;;
  esac
fi

install_path="$(prompt_input "OrderSys Installer" "Install path:" "$install_path")"
[[ -n "$install_path" ]] || { err "Install path is required."; exit 1; }

if [[ "$mode" == "update" ]]; then
  compose_file="${install_path}/runtime/prod/docker-compose.yml"
  [[ -f "$compose_file" && -f "$env_file" ]] || { err "Existing install/env files are required for update-only mode."; exit 1; }
  write_apt_manifest "$install_path"
  run_deploy_flow "$compose_file" "$env_file"
  update_http_port="${ORDERSYS_HTTP_PORT:-$(read_env_key "$env_file" ORDERSYS_HTTP_PORT)}"
  update_http_port="${update_http_port:-8080}"
  verify_health "$update_http_port"

  host_ip="$(hostname -I | awk '{print $1}')"
  access_url="http://${host_ip}:${update_http_port}"
  dns_hint="If using a hostname, keep DNS mapped to this host and ensure proxy port ${update_http_port} is reachable."
  ok "Update-only flow completed."
  show_completion_dialog "$access_url"
  show_next_steps "$access_url" "$dns_hint" "$compose_file" "$env_file"
  exit 0
fi

hostname_value="$(prompt_input "OrderSys Installer" "Public hostname (optional):" "")"
http_port="$(prompt_input "OrderSys Installer" "Proxy HTTP port:" "8080")"
http_port="${http_port:-8080}"

install -d -m 0755 /etc/ordersys
install -d -m 0755 "$install_path"
write_apt_manifest "$install_path"

compose_file="${install_path}/runtime/prod/docker-compose.yml"

existing_jwt="$(read_env_key "$env_file" JWT_SECRET_KEY)"
existing_db_password="$(read_env_key "$env_file" DB_PASSWORD)"

if [[ -n "$existing_jwt" ]]; then
  jwt_secret="$existing_jwt"
else
  jwt_secret="$(random_secret)"
fi
if [[ -n "$existing_db_password" ]]; then
  db_password="$existing_db_password"
else
  db_password="$(random_secret)"
fi

if [[ -n "$hostname_value" ]]; then
  cors_origin="http://${hostname_value}"
else
  host_ip="$(hostname -I | awk '{print $1}')"
  cors_origin="http://${host_ip}:${http_port}"
fi

backend_image="ghcr.io/robro92/ordersys-backend:0.5.3"
frontend_image="ghcr.io/robro92/ordersys-frontend:0.5.3"
proxy_image="ghcr.io/robro92/ordersys-proxy:0.5.3"

if [[ "$backend_image" == __ORDERSYS_*__ || "$frontend_image" == __ORDERSYS_*__ || "$proxy_image" == __ORDERSYS_*__ ]]; then
  err "Installer image references are not rendered. Use the official release installer artifact."
  exit 1
fi

ghcr_org_value="robro92"
app_version_value="0.5.3"

if [[ "$ghcr_org_value" == __GHCR_*__ || -z "$ghcr_org_value" ]]; then
  ghcr_org_value="$(printf '%s' "$backend_image" | sed -E 's#^ghcr\.io/([^/]+)/.*$#\1#')"
fi
if [[ "$app_version_value" == __ORDERSYS_*__ || -z "$app_version_value" ]]; then
  app_version_value="$(printf '%s' "$backend_image" | sed -E 's#^.*:([^:]+)$#\1#')"
fi

write_runtime_files "$install_path"
install -d -m 0755 "${install_path}/keys"
write_license_public_key_file "${install_path}/keys/license_public.pem"

upsert_env_key "$env_file" APP_RUNTIME_MODE "PROD"
upsert_env_key "$env_file" APP_VERSION "$app_version_value"
upsert_env_key "$env_file" ORDERSYS_VERSION "$app_version_value"
upsert_env_key "$env_file" GHCR_ORG "$ghcr_org_value"
upsert_env_key "$env_file" JWT_SECRET_KEY "$jwt_secret"
upsert_env_key "$env_file" DB_PASSWORD "$db_password"
upsert_env_key "$env_file" CORS_ALLOW_ORIGINS "$cors_origin"
upsert_env_key "$env_file" LOGIN_RL_BACKEND "redis"
upsert_env_key "$env_file" LOGIN_RL_REDIS_URL "redis://redis:6379/0"
upsert_env_key "$env_file" LOGIN_RL_MAX_KEYS "50000"
upsert_env_key "$env_file" AUTH_REFRESH_COOKIE_SAMESITE "lax"
upsert_env_key "$env_file" AUTH_REFRESH_COOKIE_ALLOW_INSECURE "true"
upsert_env_key "$env_file" TRUSTED_PROXY_CIDRS "127.0.0.1/32,::1/128,172.16.0.0/12"
upsert_env_key "$env_file" TRUSTED_PROXY_HOPS "1"
upsert_env_key "$env_file" UPDATE_CHECK_URL "https://ordersys.stonewallmedia.co.uk/update/stable.json"
upsert_env_key "$env_file" UPDATE_ALLOWED_HOSTS "ordersys.stonewallmedia.co.uk"
upsert_env_key "$env_file" UPDATE_MANIFEST_PUBLIC_KEY_PEM_FILE "${install_path}/keys/license_public.pem"
upsert_env_key "$env_file" ALLOW_UPDATE_SOURCE_OVERRIDE "false"
upsert_env_key "$env_file" UPDATE_FETCH_CONNECT_TIMEOUT_SECONDS "5"
upsert_env_key "$env_file" UPDATE_FETCH_TOTAL_TIMEOUT_SECONDS "30"
upsert_env_key "$env_file" UPDATE_FETCH_MAX_REDIRECTS "3"
upsert_env_key "$env_file" LICENSE_PUBLIC_KEY_PEM ""
upsert_env_key "$env_file" LICENSE_PUBLIC_KEY_PEM_FILE "${install_path}/keys/license_public.pem"
upsert_env_key "$env_file" ORDERSYS_INSTANCE_ID_FILE "/var/lib/ordersys/instance_id"
upsert_env_key "$env_file" ORDERSYS_HTTP_PORT "$http_port"
upsert_env_key "$env_file" ORDERSYS_BACKEND_IMAGE "$backend_image"
upsert_env_key "$env_file" ORDERSYS_FRONTEND_IMAGE "$frontend_image"
upsert_env_key "$env_file" ORDERSYS_PROXY_IMAGE "$proxy_image"
upsert_env_key "$env_file" SEED_DEV_USERS "false"
upsert_env_key "$env_file" SEED_DEMO_DATA "false"
upsert_env_key "$env_file" SEED_SAMPLE_LICENSE "false"
upsert_env_key "$env_file" FORCE_SETUP_WIZARD "false"
upsert_env_key "$env_file" SEED_UI_TEST_DATASET "false"

DEPLOY_USER="ordersys"
if ! id "$DEPLOY_USER" >/dev/null 2>&1; then
  useradd --system --create-home --shell /bin/bash "$DEPLOY_USER"
fi
chown -R "$DEPLOY_USER":"$DEPLOY_USER" "$install_path"

run_deploy_flow "$compose_file" "$env_file"
verify_health "$http_port"

if [[ -n "$hostname_value" ]]; then
  access_url="http://${hostname_value}"
  dns_hint="Point DNS A/AAAA for ${hostname_value} to this host, then keep proxy port ${http_port} reachable."
else
  host_ip="$(hostname -I | awk '{print $1}')"
  access_url="http://${host_ip}:${http_port}"
  dns_hint="Optional: configure a DNS hostname to this host IP and update CORS/ingress policy."
fi

ok "OrderSys installation complete."
show_completion_dialog "$access_url"
show_next_steps "$access_url" "$dns_hint" "$compose_file" "$env_file"
